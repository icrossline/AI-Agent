<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spark - AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --white: #ffffff;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --primary: #3b82f6;
  --primary-light: #dbeafe;
  --primary-dark: #1d4ed8;
  --success: #10b981;
  --success-light: #d1fae5;
  --warning: #f59e0b;
  --warning-light: #fef3c7;
  --danger: #ef4444;
  --danger-light: #fee2e2;
  --purple: #8b5cf6;
  --purple-light: #ede9fe;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
}

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

html, body { 
  height: 100%; 
  overflow: hidden; 
}

body {
  background: var(--gray-50);
  color: var(--gray-700);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  line-height: 1.5;
}

/* ===== LAYOUT ===== */
#app {
  display: grid;
  grid-template-rows: 64px 1fr;
  grid-template-columns: 80px 1fr;
  height: 100vh;
  background: var(--white);
}

/* ===== TOPBAR ===== */
#topbar {
  grid-column: 1 / -1;
  background: var(--white);
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  box-shadow: var(--shadow-sm);
  z-index: 10;
}

/* ===== LEFT NAVIGATION ===== */
#left-nav {
  grid-row: 2;
  grid-column: 1;
  background: var(--gray-50);
  border-right: 1px solid var(--gray-200);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
  gap: 12px;
}

.nav-icon-btn {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  color: var(--gray-600);
}

.nav-icon-btn span:first-child {
  font-size: 24px;
}

.nav-label {
  font-size: 10px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
}

.nav-icon-btn:hover {
  background: var(--white);
  border-color: var(--gray-200);
  color: var(--primary);
  transform: translateX(2px);
}

.nav-icon-btn.active {
  background: var(--primary-light);
  border-color: var(--primary);
  color: var(--primary);
  box-shadow: var(--shadow-sm);
}

.nav-icon-btn.active::before {
  content: '';
  position: absolute;
  left: -1px;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 24px;
  background: var(--primary);
  border-radius: 0 2px 2px 0;
}

/* ===== TOPBAR ===== */

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-icon {
  width: 40px; 
  height: 40px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  display: grid;
  place-items: center;
  box-shadow: var(--shadow);
}

.brand-icon svg {
  filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.4));
}

.brand-name {
  font-size: 18px;
  font-weight: 700;
  color: var(--gray-900);
  letter-spacing: -0.02em;
}

.brand-name span { 
  color: var(--primary); 
  font-weight: 600;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--gray-600);
  font-weight: 500;
}

.status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  background: var(--success-light);
  color: var(--success);
  font-size: 12px;
  font-weight: 600;
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.status-dot {
  width: 6px; 
  height: 6px;
  border-radius: 50%;
  background: var(--success);
  animation: status-blink 2s ease-in-out infinite;
}

@keyframes status-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 13px;
  color: var(--gray-600);
}

.model-badge {
  padding: 6px 12px;
  background: var(--primary-light);
  border-radius: 6px;
  color: var(--primary);
  font-size: 12px;
  font-weight: 600;
  border: 1px solid rgba(59, 130, 246, 0.2);
}

#task-count { 
  color: var(--gray-500);
  font-weight: 500;
}

/* ===== LEFT SIDEBAR ===== */
#sidebar {
  background: var(--white);
  border-right: 1px solid var(--gray-200);
  display: none;
  flex-direction: column;
  overflow: hidden;
  grid-row: 2;
  grid-column: 2;
}

.sidebar-nav {
  display: flex;
  border-bottom: 1px solid var(--gray-200);
  background: var(--gray-50);
}

.sidebar-nav-btn {
  flex: 1;
  padding: 12px 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
  border: none;
  background: none;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s ease;
  border-bottom: 2px solid transparent;
}

.sidebar-nav-btn:hover {
  color: var(--primary);
  background: var(--white);
}

.sidebar-nav-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
  background: var(--white);
}

.sidebar-block {
  padding: 20px 16px;
  border-bottom: 1px solid var(--gray-200);
}

.sidebar-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--gray-500);
  margin-bottom: 12px;
  letter-spacing: 0.05em;
}

/* Task type buttons */
.type-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.type-btn {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  padding: 12px 8px;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  font-size: 11px;
  font-weight: 500;
  color: var(--gray-600);
  transition: all 0.2s ease;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.type-btn .t-icon { 
  font-size: 20px;
}

.type-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--primary-light);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.type-btn:active {
  transform: translateY(0);
}

/* Quick prompts */
.quick-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.quick-item {
  padding: 10px 12px;
  font-size: 12px;
  color: var(--gray-600);
  border-left: 3px solid var(--gray-200);
  cursor: pointer;
  transition: all 0.2s ease;
  border-radius: 0 6px 6px 0;
  line-height: 1.4;
  background: var(--gray-50);
}

.quick-item:hover {
  border-left-color: var(--primary);
  color: var(--primary);
  background: var(--primary-light);
  padding-left: 16px;
}

/* History */
.history-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.history-scroll::-webkit-scrollbar { 
  width: 6px; 
}

.history-scroll::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 3px;
}

.history-scroll::-webkit-scrollbar-thumb { 
  background: var(--gray-300); 
  border-radius: 3px;
}

.history-scroll::-webkit-scrollbar-thumb:hover {
  background: var(--gray-400);
}

.history-entry {
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  margin-bottom: 6px;
  align-items: flex-start;
  background: var(--gray-50);
}

.history-entry:hover {
  background: var(--white);
  border-color: var(--gray-200);
  box-shadow: var(--shadow-sm);
}

.history-type-tag {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--primary-light);
  color: var(--primary);
  white-space: nowrap;
  flex-shrink: 0;
  margin-top: 1px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.history-text {
  font-size: 12px;
  color: var(--gray-600);
  line-height: 1.5;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.no-history {
  text-align: center;
  font-size: 13px;
  color: var(--gray-400);
  padding: 24px 16px;
  font-style: italic;
}

/* ===== MAIN AREA ===== */
#main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--gray-50);
  grid-row: 2;
  grid-column: 2;
}

#chat-window {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  scroll-behavior: smooth;
}

#chat-window::-webkit-scrollbar { 
  width: 6px; 
}

#chat-window::-webkit-scrollbar-track {
  background: transparent;
}

#chat-window::-webkit-scrollbar-thumb { 
  background: var(--gray-300); 
  border-radius: 3px;
}

/* Welcome screen */
#welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100%;
  gap: 20px;
  padding: 40px;
}

.welcome-ring {
  width: 100px; 
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-light), var(--purple-light));
  display: grid;
  place-items: center;
  box-shadow: var(--shadow-lg);
  animation: welcome-float 3s ease-in-out infinite;
}

@keyframes welcome-float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.welcome-ring-inner {
  width: 70px; 
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--purple));
  display: grid;
  place-items: center;
  font-size: 32px;
  box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
}

.welcome-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--gray-900);
  letter-spacing: -0.02em;
  text-align: center;
}

.welcome-sub {
  font-size: 14px;
  color: var(--gray-600);
  text-align: center;
  max-width: 480px;
  line-height: 1.6;
}

.welcome-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.welcome-tag {
  padding: 8px 16px;
  border: 1px solid var(--gray-200);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-700);
  background: var(--white);
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
}

.welcome-tag:hover {
  border-color: var(--primary);
  color: var(--primary);
  background: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

/* Messages */
.msg {
  display: flex;
  gap: 12px;
  animation: msg-in 0.3s ease;
  align-items: flex-start;
}

@keyframes msg-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.user { 
  flex-direction: row-reverse; 
}

.msg-avatar {
  width: 36px; 
  height: 36px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 16px;
  flex-shrink: 0;
  box-shadow: var(--shadow-sm);
}

.msg-avatar.agent-av {
  background: linear-gradient(135deg, var(--primary), var(--purple));
}

.msg-avatar.user-av {
  background: linear-gradient(135deg, var(--gray-300), var(--gray-400));
}

.msg-body { 
  max-width: 70%; 
  flex: 1;
}

.msg-meta {
  font-size: 11px;
  color: var(--gray-500);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}

.msg.user .msg-meta { 
  flex-direction: row-reverse; 
}

.type-tag {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
  letter-spacing: 0.03em;
  text-transform: uppercase;
}

.type-tag.schedule    { color: var(--success); background: var(--success-light); }
.type-tag.analysis    { color: var(--primary); background: var(--primary-light); }
.type-tag.search      { color: var(--warning); background: var(--warning-light); }
.type-tag.calculation { color: var(--danger); background: var(--danger-light); }
.type-tag.organization { color: var(--purple); background: var(--purple-light); }
.type-tag.textProcessing { color: #8b5cf6; background: var(--purple-light); }
.type-tag.other, .type-tag.generic { color: var(--gray-600); background: var(--gray-100); }

.bubble {
  border-radius: 12px;
  padding: 14px 18px;
  font-size: 14px;
  line-height: 1.6;
  box-shadow: var(--shadow-sm);
}

.bubble.agent {
  background: var(--white);
  border: 1px solid var(--gray-200);
  color: var(--gray-700);
}

.bubble.user {
  background: var(--primary);
  color: var(--white);
  border: 1px solid var(--primary-dark);
}

.bubble-summary {
  color: var(--gray-900);
  margin-bottom: 12px;
  font-size: 14px;
  font-weight: 600;
}

.bubble.user .bubble-summary {
  color: var(--white);
}

/* Result cards */
.result-card {
  margin-top: 12px;
  border: 1px solid var(--gray-200);
  border-radius: 10px;
  overflow: hidden;
  background: var(--gray-50);
  box-shadow: var(--shadow-sm);
}

.result-card-header {
  padding: 10px 16px;
  background: var(--primary-light);
  border-bottom: 1px solid var(--gray-200);
  font-size: 11px;
  color: var(--primary);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

.result-card-header::before {
  content: '‚óè';
  font-size: 10px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.result-card-body {
  padding: 16px;
  background: var(--white);
}

.r-row {
  display: flex;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid var(--gray-100);
  font-size: 13px;
  align-items: flex-start;
}

.r-row:last-child { 
  border-bottom: none; 
}

.r-key {
  color: var(--gray-500);
  min-width: 90px;
  flex-shrink: 0;
  font-size: 12px;
  font-weight: 600;
}

.r-val { 
  color: var(--gray-900); 
  flex: 1;
  font-weight: 500;
}

.insight-item {
  display: flex;
  gap: 10px;
  padding: 8px 0;
  font-size: 13px;
  color: var(--gray-700);
  border-bottom: 1px dashed var(--gray-200);
  align-items: flex-start;
}

.insight-item:last-child { 
  border-bottom: none; 
}

.insight-item::before {
  content: '‚ñ∏';
  color: var(--primary);
  flex-shrink: 0;
  margin-top: 1px;
  font-weight: 600;
}

.calc-result {
  font-family: 'JetBrains Mono', monospace;
  font-size: 32px;
  font-weight: 700;
  color: var(--primary);
  padding: 16px 0;
  text-align: center;
}

.search-result-item {
  padding: 12px 0;
  border-bottom: 1px solid var(--gray-100);
}

.search-result-item:last-child { 
  border-bottom: none; 
}

.search-result-title {
  font-size: 13px;
  color: var(--primary);
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  font-weight: 600;
}

.search-relevance {
  color: var(--warning);
  font-size: 12px;
  font-weight: 600;
}

.search-result-summary {
  font-size: 12px;
  color: var(--gray-600);
  line-height: 1.5;
}

/* Steps */
.steps-track {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--gray-200);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.step-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--success);
  background: var(--success-light);
  border: 1px solid rgba(16, 185, 129, 0.2);
  padding: 4px 12px;
  border-radius: 20px;
  font-weight: 600;
}

.step-pill::before {
  content: '‚úì';
  font-size: 10px;
}

/* Typing indicator */
.typing-msg {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  animation: msg-in 0.3s ease;
}

.typing-bubble {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  padding: 14px 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-shadow: var(--shadow-sm);
}

.typing-dots {
  display: flex;
  gap: 6px;
  align-items: center;
}

.t-dot {
  width: 8px; 
  height: 8px;
  border-radius: 50%;
  animation: t-bounce 1.2s ease-in-out infinite;
}

.t-dot:nth-child(1) { background: var(--primary); animation-delay: 0s; }
.t-dot:nth-child(2) { background: var(--success); animation-delay: 0.2s; }
.t-dot:nth-child(3) { background: var(--purple); animation-delay: 0.4s; }

@keyframes t-bounce {
  0%, 100% { transform: translateY(0); opacity: 0.4; }
  50% { transform: translateY(-6px); opacity: 1; }
}

.typing-status {
  font-size: 12px;
  color: var(--gray-500);
  font-weight: 500;
}

/* ===== INPUT AREA ===== */
#input-zone {
  padding: 20px 24px;
  border-top: 1px solid var(--gray-200);
  background: var(--white);
  box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.05);
}

.input-row {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  background: var(--gray-50);
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  padding: 12px 16px;
  transition: all 0.2s ease;
}

.input-row:focus-within {
  border-color: var(--primary);
  background: var(--white);
  box-shadow: 0 0 0 3px var(--primary-light);
}

.input-prompt {
  color: var(--primary);
  font-size: 18px;
  padding-bottom: 2px;
  flex-shrink: 0;
  font-weight: 600;
}

#msg-input {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--gray-900);
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  resize: none;
  min-height: 24px;
  max-height: 120px;
  line-height: 1.5;
}

#msg-input::placeholder { 
  color: var(--gray-400); 
}

#send-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border: none;
  border-radius: 10px;
  width: 40px; 
  height: 40px;
  cursor: pointer;
  display: grid;
  place-items: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
  color: var(--white);
  font-size: 16px;
  box-shadow: var(--shadow);
}

#send-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: var(--shadow-md);
}

#send-btn:active { 
  transform: scale(0.95); 
}

#send-btn:disabled { 
  opacity: 0.5; 
  cursor: not-allowed; 
}

.input-hints {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 11px;
  color: var(--gray-500);
  font-weight: 500;
}

.input-hints kbd {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: 4px;
  padding: 2px 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--gray-600);
  box-shadow: var(--shadow-sm);
}

/* ===== RESPONSIVE DESIGN ===== */

/* Tablet (768px - 1024px) */
@media (max-width: 1024px) {
  #app {
    grid-template-columns: 220px 1fr 260px;
  }
  
  .brand-name {
    font-size: 16px;
  }
  
  .type-grid {
    grid-template-columns: 1fr;
  }
  
  .msg-body {
    max-width: 80%;
  }
  
  .welcome-title {
    font-size: 24px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
}

/* Mobile Landscape & Small Tablet (600px - 768px) */
@media (max-width: 768px) {
  #app {
    grid-template-columns: 1fr;
    grid-template-rows: 60px 1fr 70px;
  }
  
  #topbar {
    padding: 0 16px;
    height: 60px;
    grid-row: 1;
    grid-column: 1;
  }
  
  #left-nav {
    grid-row: 3;
    grid-column: 1;
    flex-direction: row;
    justify-content: center;
    padding: 10px 20px;
    border-right: none;
    border-top: 1px solid var(--gray-200);
    gap: 20px;
  }
  
  .nav-icon-btn {
    width: 50px;
    height: 50px;
  }
  
  .nav-icon-btn.active::before {
    left: 50%;
    top: -1px;
    transform: translateX(-50%);
    width: 24px;
    height: 3px;
    border-radius: 0 0 2px 2px;
  }
  
  .nav-icon-btn:hover {
    transform: translateY(-2px);
  }
  
  #main {
    grid-column: 1;
    grid-row: 2;
  }
  
  #sidebar {
    grid-column: 1;
    grid-row: 2;
    max-height: none;
    border-right: none;
  }
  
  .brand-name {
    font-size: 15px;
  }
  
  .model-badge {
    font-size: 11px;
    padding: 5px 10px;
  }
  
  .sidebar-block {
    padding: 16px 12px;
  }
  
  #chat-window {
    padding: 20px 16px;
  }
  
  .msg-body {
    max-width: 85%;
  }
  
  .bubble {
    padding: 12px 16px;
    font-size: 13px;
  }
  
  #input-zone {
    padding: 16px;
  }
}

/* Mobile Portrait (up to 600px) */
@media (max-width: 600px) {
  #app {
    grid-template-rows: 56px 1fr 66px;
  }
  
  #topbar {
    padding: 0 12px;
    height: 56px;
  }
  
  .brand-icon {
    width: 36px;
    height: 36px;
  }
  
  .brand-name {
    font-size: 14px;
  }
  
  #left-nav {
    padding: 8px 20px;
    gap: 16px;
  }
  
  .nav-icon-btn {
    width: 46px;
    height: 46px;
  }
  
  .nav-label {
    font-size: 9px;
  }
  
  .model-badge {
    display: none;
  }
  
  .sidebar-block {
    padding: 16px 12px;
  }
  
  #chat-window {
    padding: 16px 12px;
    gap: 16px;
  }
  
  .welcome-ring {
    width: 80px;
    height: 80px;
  }
  
  .welcome-ring-inner {
    width: 56px;
    height: 56px;
    font-size: 24px;
  }
  
  .welcome-title {
    font-size: 20px;
  }
  
  .welcome-sub {
    font-size: 12px;
    max-width: 320px;
  }
  
  .msg-avatar {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .msg-body {
    max-width: 90%;
  }
  
  .bubble {
    padding: 10px 14px;
    font-size: 12px;
  }
  
  .calc-result {
    font-size: 24px;
  }
  
  #input-zone {
    padding: 12px;
  }
  
  .input-row {
    padding: 10px 12px;
  }
  
  #send-btn {
    width: 36px;
    height: 36px;
  }
}

/* Very Small Mobile (up to 400px) */
@media (max-width: 400px) {
  .brand-name {
    font-size: 13px;
  }
  
  .topbar-center {
    display: none;
  }
  
  .type-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .welcome-title {
    font-size: 18px;
  }
  
  .msg-body {
    max-width: 95%;
  }
}

/* Touch device optimizations */
@media (hover: none) and (pointer: coarse) {
  .type-btn, .quick-item, #send-btn, .panel-nav-btn {
    min-height: 44px;
  }
  
  .history-entry {
    padding: 12px;
  }
  
  input, textarea, button {
    font-size: 16px !important;
  }
}

</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <div class="brand">
      <div class="brand-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="10" r="7" stroke="#ffffff" stroke-width="1.5"/>
          <circle cx="10" cy="10" r="3" fill="#ffffff" opacity="0.8"/>
          <line x1="10" y1="2" x2="10" y2="5" stroke="#ffffff" stroke-width="1.5"/>
          <line x1="10" y1="15" x2="10" y2="18" stroke="#ffffff" stroke-width="1.5"/>
          <line x1="2" y1="10" x2="5" y2="10" stroke="#ffffff" stroke-width="1.5"/>
          <line x1="15" y1="10" x2="18" y2="10" stroke="#ffffff" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="brand-name">Spark <span>‚ú®</span></div>
    </div>
    <div class="topbar-right">
      <div class="model-badge">GEMINI 2.5 FLASH</div>
    </div>
  </div>

  <!-- LEFT NAVIGATION -->
  <div id="left-nav">
    <button class="nav-icon-btn active" onclick="switchView('chat', this)" title="Chat">
      <span>üí¨</span>
      <span class="nav-label">Chat</span>
    </button>
    <button class="nav-icon-btn" onclick="switchView('history', this)" title="History">
      <span>üìú</span>
      <span class="nav-label">History</span>
    </button>
  </div>

  <!-- LEFT SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-nav">
      <button class="sidebar-nav-btn active">Recent History</button>
    </div>
    <div class="sidebar-block" style="flex: 1; display: flex; flex-direction: column; border-bottom: none; padding-top: 12px;">
      <div class="history-scroll" id="history-list" style="flex: 1;">
        <div class="no-history" id="no-history">No tasks yet...</div>
      </div>
    </div>
  </div>

  <!-- MAIN CHAT -->
  <div id="main">
    <div id="chat-window">
      <div id="welcome">
        <div class="welcome-ring">
          <div class="welcome-ring-inner">ü§ñ</div>
        </div>
        <div class="welcome-title">Hello! I'm Spark ‚ú®</div>
        <div class="welcome-sub">
          Your friendly AI assistant powered by Gemini 2.5 Flash. I can help you with scheduling, data analysis, file organization, search, calculations, and text processing. What can I do for you today?
        </div>
        <div class="welcome-tags">
          <span class="welcome-tag">schedule</span>
          <span class="welcome-tag">analysis</span>
          <span class="welcome-tag">organize</span>
          <span class="welcome-tag">search</span>
          <span class="welcome-tag">calculate</span>
          <span class="welcome-tag">text</span>
        </div>
      </div>
    </div>

    <div id="input-zone">
      <div class="input-row">
        <span class="input-prompt">‚Ä∫</span>
        <textarea id="msg-input" rows="1" placeholder="Describe a task to automate..."></textarea>
        <button id="send-btn" onclick="handleSend()">‚û§</button>
      </div>
      <div class="input-hints">
        <span><kbd>Enter</kbd> send ¬∑ <kbd>Shift+Enter</kbd> new line</span>
        <span id="char-count">0 chars</span>
      </div>
    </div>
  </div>

</div>

<script>
// ============ STATE ============
const S = {
  busy: false,
  history: [],
  logs: [],
  stats: { total: 0, ok: 0, times: [], byType: {} }
};

// ============ INIT ============
window.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('msg-input');
  inp.addEventListener('input', () => {
    inp.style.height = 'auto';
    inp.style.height = Math.min(inp.scrollHeight, 120) + 'px';
    document.getElementById('char-count').textContent = inp.value.length + ' chars';
  });
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
  });
  loadHistory();
});

// ============ HISTORY (via Flask) ============
async function loadHistory() {
  try {
    const r = await fetch('/api/history');
    const d = await r.json();
    if (d.history && d.history.length) {
      S.history = d.history;
      d.history.slice(-10).reverse().forEach(t => renderHistoryEntry(t.request, t.type));
    }
  } catch (_) {}
}

async function persistHistory() {
  try {
    await fetch('/api/history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ history: S.history })
    });
  } catch (_) {}
}

// ============ UI HELPERS ============
function switchView(view, btn) {
  document.querySelectorAll('.nav-icon-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('main');
  
  if (view === 'chat') {
    sidebar.style.display = 'none';
    main.style.display = 'flex';
  } else {
    sidebar.style.display = 'flex';
    main.style.display = 'none';
  }
}

function injectPrompt(text) {
  const inp = document.getElementById('msg-input');
  inp.value = text;
  inp.style.height = 'auto';
  inp.style.height = Math.min(inp.scrollHeight, 120) + 'px';
  document.getElementById('char-count').textContent = text.length + ' chars';
  inp.focus();
  
  // Switch back to chat view when a prompt is injected
  const chatBtn = document.querySelector('.nav-icon-btn');
  if (chatBtn && !chatBtn.classList.contains('active')) {
    switchView('chat', chatBtn);
  }
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function now() {
  return new Date().toLocaleTimeString('en', { hour12: false });
}

// ============ CHAT RENDERING ============
function removeWelcome() {
  const w = document.getElementById('welcome');
  if (w) w.remove();
}

function addUserBubble(text) {
  removeWelcome();
  const cw = document.getElementById('chat-window');
  const el = document.createElement('div');
  el.className = 'msg user';
  el.innerHTML = `
    <div class="msg-avatar user-av">üë§</div>
    <div class="msg-body">
      <div class="msg-meta"><span>${now()}</span></div>
      <div class="bubble user">${esc(text)}</div>
    </div>`;
  cw.appendChild(el);
  cw.scrollTop = cw.scrollHeight;
}

function addTyping() {
  const cw = document.getElementById('chat-window');
  const el = document.createElement('div');
  el.className = 'typing-msg';
  el.id = 'typing';
  el.innerHTML = `
    <div class="msg-avatar agent-av">ü§ñ</div>
    <div class="typing-bubble">
      <div class="typing-dots"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>
      <div class="typing-status" id="typing-status">Connecting to Gemini...</div>
    </div>`;
  cw.appendChild(el);
  cw.scrollTop = cw.scrollHeight;
}

function setTypingStatus(msg) {
  const el = document.getElementById('typing-status');
  if (el) el.textContent = msg;
}

function removeTyping() {
  const el = document.getElementById('typing');
  if (el) el.remove();
}

function addAgentBubble(result, analysis) {
  const cw = document.getElementById('chat-window');
  const el = document.createElement('div');
  el.className = 'msg';
  const type = result.type || 'other';
  const data = result.data || {};
  const priority = analysis?.priority || 'medium';

  // Build result card HTML
  let cardHtml = buildResultCard(type, data);

  // Steps
  let stepsHtml = '';
  if (analysis?.steps?.length) {
    const pills = analysis.steps.map(s => `<div class="step-pill">${esc(s)}</div>`).join('');
    stepsHtml = `<div class="steps-track">${pills}</div>`;
  }

  el.innerHTML = `
    <div class="msg-avatar agent-av">ü§ñ</div>
    <div class="msg-body">
      <div class="msg-meta">
        <span>AGENT ¬∑ ${now()}</span>
        <span class="type-tag ${type}">${type.toUpperCase()}</span>
        <span class="priority-badge ${priority}">${priority}</span>
      </div>
      <div class="bubble agent">
        ${result.summary ? `<div class="bubble-summary">${esc(result.summary)}</div>` : ''}
        ${cardHtml}
        ${stepsHtml}
      </div>
    </div>`;
  cw.appendChild(el);
  cw.scrollTop = cw.scrollHeight;
}

function buildResultCard(type, data) {
  if (type === 'schedule' && data.title) {
    return `<div class="result-card">
      <div class="result-card-header">SCHEDULED EVENT</div>
      <div class="result-card-body">
        <div class="r-row"><span class="r-key">Event</span><span class="r-val">${esc(data.title)}</span></div>
        <div class="r-row"><span class="r-key">Date/Time</span><span class="r-val">${esc(data.datetime||'‚Äî')}</span></div>
        <div class="r-row"><span class="r-key">Duration</span><span class="r-val">${esc(data.duration||'‚Äî')}</span></div>
        ${data.notes ? `<div class="r-row"><span class="r-key">Notes</span><span class="r-val">${esc(data.notes)}</span></div>` : ''}
      </div>
    </div>`;
  }

  if (type === 'analysis' && data.insights) {
    const insights = data.insights.map(i => `<div class="insight-item">${esc(i)}</div>`).join('');
    const metrics = data.metrics
      ? Object.entries(data.metrics).map(([k,v]) => `<div class="r-row"><span class="r-key">${esc(k)}</span><span class="r-val">${esc(String(v))}</span></div>`).join('')
      : '';
    return `<div class="result-card">
      <div class="result-card-header">ANALYSIS RESULTS</div>
      <div class="result-card-body">
        <div style="font-size:10px;color:var(--gray-500);font-weight:600;letter-spacing:0.05em;text-transform:uppercase;margin-bottom:8px;">Key Insights</div>
        ${insights}
        ${metrics ? `<div style="font-size:10px;color:var(--gray-500);font-weight:600;letter-spacing:0.05em;text-transform:uppercase;margin:10px 0 6px;">Metrics</div>${metrics}` : ''}
      </div>
    </div>`;
  }

  if (type === 'organization' && data.categories) {
    const cats = data.categories.map((c,i) => `<div class="r-row"><span class="r-key">Cat ${i+1}</span><span class="r-val">${esc(c)}</span></div>`).join('');
    return `<div class="result-card">
      <div class="result-card-header">FILE ORGANIZATION</div>
      <div class="result-card-body">${cats}</div>
    </div>`;
  }

  if (type === 'search' && data.results) {
    const results = data.results.map(r => `
      <div class="search-result-item">
        <div class="search-result-title">
          <span>${esc(r.title)}</span>
          <span class="search-relevance">${esc(r.relevance)}</span>
        </div>
        <div class="search-result-summary">${esc(r.summary)}</div>
      </div>`).join('');
    return `<div class="result-card">
      <div class="result-card-header">SEARCH RESULTS ¬∑ ${data.totalFound || data.results.length} found</div>
      <div class="result-card-body">${results}</div>
    </div>`;
  }

  if (type === 'calculation' && data.result !== undefined) {
    const steps = data.steps
      ? data.steps.map((s,i) => `<div class="r-row"><span class="r-key">Step ${i+1}</span><span class="r-val">${esc(s)}</span></div>`).join('')
      : '';
    return `<div class="result-card">
      <div class="result-card-header">CALCULATION</div>
      <div class="result-card-body">
        <div class="calc-result">${esc(String(data.result))}</div>
        ${steps}
        ${data.explanation ? `<div class="r-row"><span class="r-key">Explanation</span><span class="r-val">${esc(data.explanation)}</span></div>` : ''}
      </div>
    </div>`;
  }

  if (type === 'textProcessing' && data.processed) {
    return `<div class="result-card">
      <div class="result-card-header">TEXT PROCESSED ¬∑ ${data.wordCount||0} words</div>
      <div class="result-card-body" style="white-space:pre-wrap;font-size:13px;color:var(--gray-700);">${esc(data.processed)}</div>
    </div>`;
  }

  if (data.response) {
    return `<div class="result-card">
      <div class="result-card-header">RESPONSE</div>
      <div class="result-card-body" style="white-space:pre-wrap;font-size:13px;color:var(--gray-700);line-height:1.6;">${esc(data.response)}</div>
    </div>`;
  }

  return '';
}

function addErrorBubble(msg) {
  const cw = document.getElementById('chat-window');
  const el = document.createElement('div');
  el.className = 'msg';
  el.innerHTML = `
    <div class="msg-avatar agent-av">ü§ñ</div>
    <div class="msg-body">
      <div class="bubble agent" style="border-color:var(--danger);background:var(--danger-light);">
        <span style="color:var(--danger);font-weight:600;">‚ùå ${esc(msg)}</span>
      </div>
    </div>`;
  cw.appendChild(el);
  cw.scrollTop = cw.scrollHeight;
}

// ============ HISTORY PANEL ============
function renderHistoryEntry(request, type) {
  const list = document.getElementById('history-list');
  const noH = document.getElementById('no-history');
  if (noH) noH.remove();

  const el = document.createElement('div');
  el.className = 'history-entry';
  el.onclick = () => injectPrompt(request);
  el.innerHTML = `
    <span class="history-type-tag">${esc(type)}</span>
    <span class="history-text">${esc(request.length > 50 ? request.slice(0,50)+'...' : request)}</span>`;
  list.insertBefore(el, list.firstChild);

  while (list.children.length > 15) list.removeChild(list.lastChild);
}

// ============ GEMINI API (via Flask) ============
async function callGemini(prompt) {
  const response = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });
  const data = await response.json();
  if (data.error) throw new Error(data.error);
  return data.text;
}

// ============ TASK EXECUTORS ============
const PROMPTS = {
  schedule: p => `You are a scheduling assistant. Based on this information, create a structured schedule entry. Respond ONLY with JSON (no markdown, no backticks):
{"title":"event title","datetime":"parsed date and time","duration":"estimated duration","notes":"any additional details"}

Info: ${JSON.stringify(p)}`,

  dataAnalysis: p => `You are a data analyst. Analyze the following and provide insights in JSON format (no markdown, no backticks):
{"insights":["insight 1","insight 2"],"metrics":{"metric":"value"},"recommendations":["recommendation 1"]}

Data: ${JSON.stringify(p)}`,

  fileOrganization: p => `You are a file organization expert. Suggest an organization structure in JSON (no markdown, no backticks):
{"categories":["category1","category2"],"structure":{"category":["items"]},"rules":["rule 1"]}

Request: ${JSON.stringify(p)}`,

  search: p => `You are a search assistant. Provide relevant results in JSON (no markdown, no backticks):
{"results":[{"title":"result 1","relevance":"95%","summary":"brief summary"},{"title":"result 2","relevance":"87%","summary":"brief summary"}],"totalFound":5}

Query: ${JSON.stringify(p)}`,

  textProcessing: p => `You are a text processing AI. Process the following and return results in JSON (no markdown, no backticks):
{"processed":"the processed text","wordCount":0,"summary":"brief summary of what was done"}

Request: ${JSON.stringify(p)}`,

  calculation: p => `You are a calculation assistant. Solve this and return results in JSON (no markdown, no backticks):
{"result":"the calculated result","steps":["step 1","step 2"],"explanation":"brief explanation"}

Problem: ${JSON.stringify(p)}`
};

const TYPE_MAP = { dataAnalysis:'analysis', fileOrganization:'organization' };
const SUMMARIES = {
  schedule:        d => `‚úÖ Scheduled: ${d.title||'event'} at ${d.datetime||'TBD'}`,
  dataAnalysis:    d => `üìä Analysis complete: ${(d.insights||[]).length} insights found`,
  fileOrganization:d => `üìÅ Organized into ${(d.categories||[]).length} categories`,
  search:          d => `üîç Found ${d.totalFound||(d.results||[]).length} results`,
  textProcessing:  d => `üìù Text processed: ${d.wordCount||0} words`,
  calculation:     d => `üî¢ Result: ${d.result}`
};

async function executeTask(analysis, userRequest) {
  const type = analysis.taskType;
  const params = analysis.parameters;

  if (PROMPTS[type]) {
    const raw = await callGemini(PROMPTS[type](params));
    const clean = raw.replace(/```json|```/g,'').trim();
    try {
      const data = JSON.parse(clean);
      const rtype = TYPE_MAP[type] || type;
      return { type: rtype, data, summary: (SUMMARIES[type]||(() => '‚úÖ Done'))(data) };
    } catch {
      return { type: TYPE_MAP[type]||type, data: { response: raw }, summary: '‚úÖ Task completed' };
    }
  }

  // Generic
  const raw = await callGemini(`You are a helpful automation assistant. Process this request and provide a helpful response.\n\nRequest: ${userRequest}`);
  return { type: 'generic', data: { response: raw }, summary: '‚úÖ Task completed' };
}

// ============ MAIN SEND HANDLER ============
async function handleSend() {
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if (!text || S.busy) return;

  S.busy = true;
  document.getElementById('send-btn').disabled = true;
  inp.value = '';
  inp.style.height = 'auto';
  document.getElementById('char-count').textContent = '0 chars';

  addUserBubble(text);
  addTyping();
  const t0 = Date.now();

  try {
    // Step 1: Analyze
    setTypingStatus('Analyzing task type...');

    const analysisPrompt = `You are a task analysis AI. Analyze this request and respond ONLY with a JSON object (no markdown, no backticks):
{
  "taskType": "one of: schedule, dataAnalysis, fileOrganization, search, textProcessing, calculation, other",
  "parameters": {"key": "value pairs of extracted info"},
  "steps": ["step 1", "step 2", "step 3"],
  "priority": "high/medium/low"
}

Request: ${text}`;

    const analysisRaw = await callGemini(analysisPrompt);
    let analysis;
    try {
      analysis = JSON.parse(analysisRaw.replace(/```json|```/g,'').trim());
    } catch {
      analysis = { taskType: 'other', parameters: { request: text }, steps: ['Process request', 'Generate response'], priority: 'medium' };
    }

    // Step 2: Execute
    setTypingStatus(`Running ${analysis.taskType} handler...`);

    const result = await executeTask(analysis, text);
    const elapsed = ((Date.now() - t0) / 1000).toFixed(1);

    // Update state
    S.stats.total++;
    S.stats.ok++;
    S.stats.times.push(parseFloat(elapsed));
    S.stats.byType[analysis.taskType] = (S.stats.byType[analysis.taskType]||0) + 1;
    S.history.push({ timestamp: new Date().toISOString(), request: text, type: result.type });

    renderHistoryEntry(text, analysis.taskType);
    persistHistory();

    removeTyping();
    addAgentBubble(result, analysis);

  } catch (err) {
    removeTyping();
    addErrorBubble(err.message);
    S.stats.total++;
  }

  S.busy = false;
  document.getElementById('send-btn').disabled = false;
  inp.focus();
}
</script>
</body>
</html>
